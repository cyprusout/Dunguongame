<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Document</title>
	<link rel="icon" type="image/x-icon" href="icon.png">
	<style>
		canvas{
			background-color:black;
		}
	</style>
	<script src="helpers.js"></script>
	<script src="sprite.js"></script>
	<script src="input.js"></script>
</head>
<body>
	<canvas width=800 height=600></canvas>
	<script>
		const canvas = obj('canvas');
		const ctx = canvas.getContext('2d');
		ctx.fillStyle = 'white';
		ctx.font = '40px sans-serif';
		ctx.fillText('Press Space to Start',50,50);
		ctx.fill();

		var player = new Sprite('player.png');

		var bullets = [];
		var enemies = [];

		document.on('keydown',e=>{
			if(e.key == ' '){
				start();
			}
		});

		keys.start();



		class Bullet extends Sprite{
			constructor(x,y,d){
				super('bullet.png');
				this.position = new Vector(x,y);
				this.direction = d;
				this.speed = 7;
			}
			fly(){
				let pos = this.pos;
				pos.x += this.speed * Math.cos(this.dir*Math.PI/180);
				pos.y += this.speed * Math.sin(this.dir*Math.PI/180);
				this.position = pos;
				if(pos.y > 1000 || pos.y < -50 || pos.x > 1500 || pos.x < -50){
					bullets.splice(bullets.indexOf(this),1);
				}
			}
		}

		class Enemy extends Sprite{
			constructor(x,y){
				super('enemy.png');
				this.speed = 1;
				this.position = new Vector(x,y);
				this.cooldown = 10;
			}
			attack(){
				let x = this.pos.x;
				let y = this.pos.y;
				let d = Vector.getDir(x-player.pos.x,y-player.pos.y);
				this.direction = d;
				let pos = this.pos;
				d += 30;
				pos.x += this.speed * Math.cos(d*Math.PI/180);
				pos.y += this.speed * Math.sin(d*Math.PI/180);
				this.position = pos;
				this.cooldown--;
				d-= 30;
				if(this.cooldown == 0){
					this.cooldown = 30;
					let b1 = new Bullet(pos.x,pos.y,d);
					let b2 = new Bullet(pos.x,pos.y,d-35);
					let b3 = new Bullet(pos.x,pos.y,d+35);
					bullets.push(b1,b2,b3);
				}
			}
		}

		function spawnEnemy(){
			let ne = new Enemy(random(50,canvas.width-50),50);
			enemies.push(ne);
		}

		function inputHandle(){
			let speed = 8;
			let pos = player.pos;
			if(keys.down('w')){
				pos.y -= speed;
			}
			if(keys.down('s')){
				pos.y += speed;
			}
			if(keys.down('a')){
				pos.x -= speed;
			}
			if(keys.down('d')){
				pos.x += speed;
			}
			player.slideTo(pos.x,pos.y);
		}

		function start(){
			canvas.requestFullscreen();
			player.position = new Vector(100,100);
			loop();
		}

		let i = 0;
		var max_enemies = 5;
		function loop(){
			setTimeout(loop,1000/30);
			ctx.clearRect(-2,-2,canvas.width+2,canvas.height+2);
			inputHandle();
			player.draw();
			if(i++ % 100 == 0 && enemies.length < max_enemies){
				spawnEnemy();
			}
			if(i++ % 10 == 5){
				shoot();
			}
			for(let b of bullets) b.fly();
			for(let b of bullets) b.draw();
			for(let e of enemies) e.attack();
			for(let e of enemies) e.draw();
		}

		function shoot(){
			let x = random(0,canvas.width);
			let y = 0;
			let d = Vector.getDir(x-player.pos.x,y-player.pos.y);
			// let d = 90;
			let nb = new Bullet(x,y,d);
			bullets.push(nb);
		}

	</script>
</body>
</html>