<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Document</title>
	<link rel="icon" type="image/x-icon" href="icon.png">
	<style>
		canvas{
			background-color:black;
		}
	</style>
	<script src="helpers.js"></script>
	<script src="sprite.js"></script>
	<script src="input.js"></script>
</head>
<body>
	<canvas width=1200 height=800></canvas>
	<script>
		const canvas = obj('canvas');
		const ctx = canvas.getContext('2d');
		ctx.fillStyle = 'white';
		ctx.font = '40px sans-serif';
		ctx.fillText('Press Space to Start',50,50);
		ctx.fill();

		var player = new Sprite('Player/0.png');

		var bullets = [];
		var enemies = [];

		document.on('keydown',e=>{
			if(e.key == ' '){
				start();
			}
		});

		keys.start();
		mouse.start(canvas);

		var background = new Sprite('sandmap.png');


		class Bullet extends Sprite{
			constructor(x,y,d){
				super('bullet.png');
				this.position = new Vector(x,y);
				this.direction = d;
				this.speed = 7;
			}
			fly(){
				let pos = this.pos;
				pos.x += this.speed * Math.cos(this.dir*Math.PI/180);
				pos.y += this.speed * Math.sin(this.dir*Math.PI/180);
				this.position = pos;
				if(pos.y > background.h/2 || pos.y < -background.h/2 || pos.x < -background.w/2 || pos.x > background.w/2){
					bullets.splice(bullets.indexOf(this),1);
				}
			}
		}

		class Enemy extends Sprite{
			constructor(x,y){
				super('enemy.png');
				this.speed = 1;
				this.position = new Vector(x,y);
				this.cooldown = 10;
				this.md = 80 * ((Math.random() > .5) ? -1 : 1);
			}
			attack(){
				let x = this.pos.x;
				let y = this.pos.y;
				let d = Vector.getDir(x-player.pos.x,y-player.pos.y);
				this.direction = d;
				let pos = this.pos;
				d += this.md;
				pos.x += this.speed * Math.cos(d*Math.PI/180);
				pos.y += this.speed * Math.sin(d*Math.PI/180);
				this.position = pos;
				this.cooldown--;
				d -= this.md;
				if(this.cooldown == 0){
					this.cooldown = 30;
					let b1 = new Bullet(pos.x,pos.y,d);
					let b2 = new Bullet(pos.x,pos.y,d-35);
					let b3 = new Bullet(pos.x,pos.y,d+35);
					bullets.push(b1,b2,b3);
				}
			}
		}

		function spawnEnemy(){
			let ne = new Enemy(random(50,canvas.width-50),50);
			enemies.push(ne);
		}

		function inputHandle(){
			let speed = 8;
			let pos = player.pos;
			if(keys.down('w')){
				pos.y -= speed;
			}
			if(keys.down('s')){
				pos.y += speed;
			}
			if(keys.down('a')){
				pos.x -= speed;
				player.transformX = -1;
			}
			if(keys.down('d')){
				pos.x += speed;
				player.transformX = 1;
			}
			if(keys.down('e')){
				keys.keys['e'] = false;
				nWeapon();
			}
			player.slideTo(pos.x,pos.y);
			weapon.direction = Vector.getDir(canvas.width/2-mouse.pos.x,canvas.height/2-mouse.pos.y);
			weapon.position = Vector.getPointIn(weapon.dir * Math.PI / 180,weapon_dist,pos.x,pos.y);
		}

		function useSpear(){
			weapon = new Sprite('spear/0.png');
			weapon.addAnimation('spear/stab.anims');
			weapon.scale = new Vector(1,.3);
			weapon_action = 'stab';
			weapon_dist = 25;
		}
		function useMace(){
			weapon = new Sprite('mace/0.png');
			weapon.addAnimation('mace/mace.anims');
			weapon_action = 'swing';
			weapon_dist = 20;
			weapon.transformX = -1;
		}
		function useLongSword(){
			weapon = new Sprite('longsword/0.png');
			weapon.addAnimation('longsword/longsword.anims');
			weapon_action = 'swing';
			weapon_dist = 40;
			weapon.transformX = -1;
		}
		function useKnives(){
			weapon = new Sprite('knives/0.png');
			weapon.addAnimation('knives/knife.anims');
			weapon_action = 'stab';
			weapon_dist = 15;
		}

		var equips = [useSpear,useMace,useLongSword,useKnives];
		var weapon_ix = 0;
		function nWeapon(){
			weapon_ix = (weapon_ix+1) % equips.length;
			equips[weapon_ix]();
		}

		var weapon;
		var weapon_action = '';
		var weapon_dist = 0;

		useSpear();

		function start(){
			if(!started){
				started = true;
				player.position = new Vector(canvas.width/2,canvas.height/2);
				loop();
			}				
			canvas.requestFullscreen();
		}

		Hitbox.show = false;

		map.position = new Vector(-canvas.width/2,-canvas.height/2);

		let i = 0;
		var max_enemies = 3;
		var started = false;

		function loop(){
			ctx.clearRect(-2,-2,canvas.width+2,canvas.height+2);
			setTimeout(loop,1000/30);
			ctx.save();
			ctx.translate(-player.pos.x+canvas.width/2,-player.pos.y+canvas.height/2);
			inputHandle();
			background.draw();
			player.draw();
			if(i++ % 1000 == 0 && enemies.length < max_enemies){
				spawnEnemy();
			}
			if(i++ % 10 == 5){
				// shoot();
			}
			for(let b of bullets) b.fly();
			for(let b of bullets) b.draw();
			for(let e of enemies) e.attack();
			for(let e of enemies) e.draw();
			weapon.draw();
			if(mouse.down){
				try{
					weapon.animation.play(weapon_action);
				} catch(e){
					console.log('Animation didn\'t load fast enough');
				}
			}
			ctx.restore();
		}

		function shoot(){
			let x = random(0,canvas.width);
			let y = 0;
			// let d = Vector.getDir(x-player.pos.x,y-player.pos.y);
			let d = 90;
			let nb = new Bullet(x,y,d);
			bullets.push(nb);
		}

	</script>
</body>
</html>